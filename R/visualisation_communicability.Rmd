---
title: "visualisation"
author: "MG"
date: "2023-05-03"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("~/Fac/Master_Rennes/stage1/edges")

library(tidyverse)
library(ggpubr)
library(igraph)
library(ggrepel)
library(RColorBrewer)
source("R/functions.R")
```

```{r}
main_theme = theme_bw()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=17),
        axis.text.y = element_text(colour = "black", size=17),
        legend.title = element_text(colour = "black", size=17),
        legend.text = element_text(colour = "black", size=15),
        axis.title=element_text(size=15))
```

```{r}
communicability_df = read.csv("output/communicability_df.csv",
                         stringsAsFactors = T)
```
## Check the link between the importance metrique(I) and the communicability (G)
$$G=\sum^n_{j=1}\varphi_j\varphi_j^Te^{\lambda_j}$$
with $\varphi_j = $eigenvector associate with the eigenvalue j

$$I = G - \zeta G$$

### Communicability and importance differente metrics
Communicability_df was produce by the *"communicability_parallel_process.R"* function.
```{r}

ggplot(communicability_df)+
  geom_point(aes(G_pq_clover_nrmlz, G_pq_trefle_nrmlz))+
  geom_abline(intercept= 0, slope = 1, col = "blue")+
  main_theme

ggplot(communicability_df)+
  geom_point(aes(importance_clover_nrmlz,importance_trefle_nrmlz ))+
  geom_abline(intercept= 0, slope = 1, col = "blue")+
  main_theme
ggplot(communicability_df)+
  geom_point(aes(f_norm_G_clover_nrmlz,f_norm_G_trefle_nrmlz))+
  main_theme
ggplot(communicability_df)+
  geom_point(aes(f_norm_G_clover,f_norm_G_trefle))+
  main_theme
communicability_df[communicability_df$f_norm_G_trefle_nrmlz>0.5,]
```
### Histograme des varaible les plis intersantes
```{r}
str(communicability_df)
G_nrmlz_subset = communicability_df %>%
  select(c(virus, host, X, G_pq_clover_nrmlz, G_pq_trefle_nrmlz))%>%
  pivot_longer(-c(virus, host, X),values_to ="G_nrmlz")

hist_G = ggplot(G_nrmlz_subset)+
  geom_density(aes(G_nrmlz, fill = name),alpha = 0.2, stat = "density")+
  fill_palette("pastel1")+
  main_theme+
  scale_fill_discrete(name = "Network", labels = c("clover", "trefle"))+
  labs(x ="Communicability (G)", y= "Density") 

I_nrmlz_subset = communicability_df %>%
  select(c(virus, host, X, importance_trefle_nrmlz, importance_clover_nrmlz))%>%
  pivot_longer(-c(virus, host, X),values_to ="I_nrmlz")

str(G_nrmlz_subset)

hist_I = ggplot(I_nrmlz_subset)+
  geom_density(aes(I_nrmlz, fill = name),alpha = 0.2, stat = "density")+
  fill_palette("pastel1")+
  scale_fill_discrete(name = "Network", labels = c("clover", "trefle"))+
  labs(x ="Importance", y= "Density") +
  main_theme


gg_G2  = ggplot()+
  geom_point(data=communicability_df, aes(G_pq_clover_nrmlz, G_pq_trefle_nrmlz))+
  geom_abline(intercept= 0, slope = 1, col = "blue")+
  geom_text_repel(data=subset(communicability_df, G_pq_trefle_nrmlz > 0.375 |
                                G_pq_clover_nrmlz > 0.2),
            aes(G_pq_clover_nrmlz,G_pq_trefle_nrmlz, label = paste(host, "(", virus, ")", sep = "")),
            size=4,
            box.padding = unit(0.5, "lines"),
            max.overlaps =20)+
  labs(x ="G colver", y= "G trefle")+
  main_theme

gg_I2 = ggplot(communicability_df)+
  geom_point(aes(importance_clover_nrmlz, importance_trefle_nrmlz))+
  geom_abline(intercept= 0, slope = 1, col = "blue")+
  geom_text_repel(data=subset(communicability_df, importance_trefle_nrmlz > 0.0055 |
                                  (importance_trefle_nrmlz > 0.005 & importance_clover_nrmlz > 0.03) |
                                importance_clover_nrmlz > 0.04),
                    
            aes(importance_clover_nrmlz,importance_trefle_nrmlz, label = paste(host, "(", virus, ")", sep = "")),
            size=4,
            box.padding = unit(0.5, "lines"),
            max.overlaps = 20)+

  labs(x ="I colver", y= "I trefle")+
  main_theme
gg_trefle = ggplot(communicability_df)+
  geom_point(aes(G_pq_trefle_nrmlz, importance_trefle_nrmlz))+
  geom_abline(intercept= 0, slope = 1, col = "blue")+
  labs(x ="G trefle", y= "I trefle")+
  main_theme
ggarrange(hist_G,gg_G2, ncol =2)
ggarrange(hist_I,gg_I2, ncol =2)
communicability_df$host[communicability_df$importance_clover_nrmlz > 0.03]
```
### compaire I of the link and the global impact of the removal with forbenuis norm difference of matrice communicability
Information loss with the I metric, the f norm show that the link have always the same impact or less on the network than what it is possible to interpret soley with I
```{r}
ggplot(communicability_df)+
  geom_point(aes(importance_trefle_nrmlz,f_norm_G_trefle ))+
  labs(x ="I trefle", y= "f_norm trefle")+
  main_theme
ggplot(communicability_df)+
  geom_point(aes(importance_clover_nrmlz,f_norm_G_clover))+
  labs(x ="I clover", y= "f_norm clover")+
  main_theme

```

```{r include=FALSE}
clover = read.csv("data/clover.csv", stringsAsFactors = T)
str(clover)
trefle = read.csv("data/trefle.csv", stringsAsFactors = T)
uni_ntw_trefle = matrix.associations.uni(Virus = trefle$virus, Host = trefle$host)
uni_ntw_clover =  matrix.associations.uni(Virus = clover$Virus, Host = clover$Host)

grh_clover = graph_from_data_frame(communicability_df[,2:3])
grh_clover = graph_from_adjacency_matrix(uni_ntw_clover)
grh_trefle = graph_from_adjacency_matrix(uni_ntw_trefle)
which(communicability_df$importance_clover_nrmlz>= 0.03 &
                    communicability_df$f_norm_G_clover>= -1*10**10)
edge_color = ifelse(communicability_df$importance_clover_nrmlz>= 0.03 &
                    communicability_df$f_norm_G_clover>= -1*10**10, "blue",
                  ifelse(communicability_df$importance_clover_nrmlz>= 0.03, "red", "gray" ))
str(edge_color)
str(communicability_df)
##### Edges value from trefle
#lay = layout_with_dh(grh_clover)
lay2 = layout.auto(grh_clover)
str(grh_clover)
plot(grh_trefle, vertex.size=1,vertex.label=NA,
      vertex.label.cex = 2,edge.width = 8,
     edge.label=NA,edge.label.cex = 2)
##### Edges value from clover

```
### Linking importance to biological
```{r}
str(communicability_df)
str(temp)
length(duplicated(temp))-sum(duplicated(communicability_df[,2:3]))
clvr_colsub = clover[,colnames(clover) %in% c("HostOrder","HostFamily", "VirusOrder", "VirusFamily",
                                            "Virus", "Host")]
clvr_colsub = clvr_colsub[!duplicated(clvr_colsub),]
temp = communicability_df%>%
  full_join(clvr_colsub, by =c("host" ="Host", "virus" = "Virus"))
str(temp)
ggplot(temp)+
  geom_boxplot(aes(HostOrder, importance_clover_nrmlz))
ggplot()+
  geom_boxplot(data=temp[temp$importance_trefle_nrmlz>0,], aes(HostOrder, importance_trefle_nrmlz))

hist_host= ggplot()+
  geom_density(data=temp, aes(importance_trefle_nrmlz,group= HostOrder, fill =HostOrder),
               position="fill")+
  main_theme
hist_virus= ggplot()+
  geom_density(data=temp, aes(importance_trefle_nrmlz,group =VirusOrder ,fill =VirusOrder),
               position="fill")+
  main_theme
ggarrange(hist_host, hist_virus)
ggplot() +
  geom_density(data = temp[temp$importance_trefle_nrmlz>0,], aes(importance_trefle_nrmlz, fill = HostOrder),alpha = 0.4) +
  main_theme
hist_h_trefle = ggplot() +
  geom_density() +
  geom_area(data = temp[temp$importance_trefle_nrmlz>0,], aes(importance_trefle_nrmlz, fill = HostOrder), stat = "density")+
  main_theme

hist_v_trefle = ggplot() +
  geom_density() +
  geom_area(data = temp[temp$importance_trefle_nrmlz>0,], aes(importance_trefle_nrmlz, fill = VirusOrder), stat = "density")+
  main_theme

hist_h_clover = ggplot() +
  geom_density() +
  geom_area(data = temp[temp$importance_clover_nrmlz>0.001,], aes(importance_clover_nrmlz, fill = HostOrder), stat = "density")+
  main_theme

hist_v_clover= ggplot() +
  geom_density() +
  geom_area(data = temp[temp$importance_clover_nrmlz>0.001,], aes(importance_clover_nrmlz, fill = VirusOrder), stat = "density")+
  main_theme
ggarrange(hist_h_clover,hist_v_clover, hist_h_trefle, hist_v_trefle)

```

